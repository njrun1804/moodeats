<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodEats - What's for dinner?</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.2/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
</head>
<body class="min-h-screen bg-base-100">
    <div class="max-w-4xl mx-auto p-4">
        <header class="text-center mb-8 pt-8">
            <h1 class="text-4xl font-bold mb-2">MoodEats</h1>
            <p class="text-base-content/60">What are you in the mood for?</p>
        </header>

        <div class="space-y-6">
            <div class="card bg-base-200">
                <div class="card-body">
                    <h3 class="card-title text-lg mb-4">Pick a vibe or describe what you want</h3>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                        <button class="mood-btn btn btn-outline" data-mood="cozy">
                            üç≤ Cozy
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="fresh">
                            ü•ó Fresh
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="hearty">
                            üçñ Hearty
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="quick">
                            ‚ö° Quick
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="breakfast">
                            üåÖ Breakfast
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="seafood">
                            üêü Seafood
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="asian">
                            ü•¢ Asian
                        </button>
                        <button class="mood-btn btn btn-outline" data-mood="italian">
                            üçù Italian
                        </button>
                    </div>

                    <div class="relative">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Or type what you're craving... (e.g., 'something with shrimp', 'pasta but light', 'warm and cheesy')"
                            class="input input-bordered w-full pr-10"
                        >
                        <button id="searchBtn" class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-sm btn-circle">
                            üîç
                        </button>
                    </div>
                </div>
            </div>

            <div id="suggestionsArea" class="hidden">
                <div class="card bg-base-200">
                    <div class="card-body">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="card-title text-lg">How about these?</h3>
                            <span id="resultCount" class="text-sm text-base-content/60"></span>
                        </div>
                        <div id="mealSuggestions" class="space-y-3">
                        </div>
                        <button id="showMore" class="btn btn-ghost btn-sm mt-4">
                            Show 3 more ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <div id="selectedMeal" class="hidden">
                <div class="card bg-primary/5 border-2 border-primary">
                    <div class="card-body">
                        <h3 class="card-title text-xl" id="selectedMealName"></h3>
                        <div class="mt-4">
                            <h4 class="font-semibold mb-2">What you'll need:</h4>
                            <div id="ingredientsList" class="space-y-4">
                            </div>
                        </div>
                        <div class="card-actions mt-4">
                            <button id="clearSelection" class="btn btn-ghost btn-sm">
                                ‚Üê Pick something else
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="recentMeals" class="hidden">
                <div class="card bg-base-200/50">
                    <div class="card-body">
                        <h4 class="font-semibold text-sm text-base-content/60">Recently viewed:</h4>
                        <div id="recentMealsList" class="flex gap-2 flex-wrap">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Choice theory optimized settings
        const INITIAL_SHOW = 3;  // Show 3 initially (down from 5)
        const MORE_INCREMENT = 3; // Show 3 more each time
        const RECENT_MEALS_KEY = 'moodeats:recent';
        const MAX_RECENT = 3;

        let meals = [];
        let currentSuggestions = [];
        let suggestionIndex = 0;
        let fuse;
        let recentMeals = [];

        // Load meals from external JSON
        async function loadMeals() {
            try {
                const response = await fetch('meals.json');
                meals = await response.json();
                initFuzzySearch();
                loadRecentMeals();
            } catch (error) {
                console.error('Error loading meals:', error);
                // Fallback: could load a minimal set inline if needed
            }
        }

        function initFuzzySearch() {
            const options = {
                keys: ['name', 'searchTerms'],
                threshold: 0.4,
                includeScore: true
            };
            fuse = new Fuse(meals, options);
        }

        function getMealsByMood(mood) {
            return meals.filter(meal => meal.moods.includes(mood));
        }

        function searchMeals(query) {
            const results = fuse.search(query);
            return results.map(result => result.item);
        }

        // Smart ordering: prioritize variety and quick options
        function smartSort(meals) {
            const sorted = [...meals];

            // Group by category to ensure variety
            const byCategory = {};
            sorted.forEach(meal => {
                if (!byCategory[meal.category]) byCategory[meal.category] = [];
                byCategory[meal.category].push(meal);
            });

            // Interleave categories for variety
            const result = [];
            const categories = Object.keys(byCategory);
            let maxLength = Math.max(...categories.map(c => byCategory[c].length));

            for (let i = 0; i < maxLength; i++) {
                categories.forEach(category => {
                    if (byCategory[category][i]) {
                        result.push(byCategory[category][i]);
                    }
                });
            }

            // Prioritize quick meals in first batch
            return result.sort((a, b) => {
                const aQuick = a.moods.includes('quick') ? -1 : 0;
                const bQuick = b.moods.includes('quick') ? -1 : 0;
                return aQuick - bQuick;
            });
        }

        function displaySuggestions() {
            const container = document.getElementById('mealSuggestions');
            container.innerHTML = '';

            const toShow = currentSuggestions.slice(suggestionIndex, suggestionIndex + INITIAL_SHOW);

            if (toShow.length === 0) {
                container.innerHTML = '<p class="text-base-content/60">No matches found. Try a different search or mood!</p>';
                document.getElementById('showMore').classList.add('hidden');
                document.getElementById('resultCount').textContent = '';
                return;
            }

            // Update count
            const showing = Math.min(suggestionIndex + INITIAL_SHOW, currentSuggestions.length);
            document.getElementById('resultCount').textContent =
                `Showing ${showing} of ${currentSuggestions.length}`;

            toShow.forEach((meal, index) => {
                const mealCard = document.createElement('div');
                mealCard.className = 'card bg-base-100 cursor-pointer hover:bg-base-300 transition-colors';

                // Add subtle priority indicators
                let priorityBadge = '';
                if (index === 0 && suggestionIndex === 0) {
                    priorityBadge = '<span class="badge badge-primary badge-sm">Popular</span>';
                } else if (meal.moods.includes('quick')) {
                    priorityBadge = '<span class="badge badge-accent badge-sm">Quick</span>';
                }

                mealCard.innerHTML = `
                    <div class="card-body p-4">
                        <div class="flex justify-between items-start">
                            <h4 class="font-semibold">${meal.name}</h4>
                            ${priorityBadge}
                        </div>
                        <div class="flex gap-2 mt-2">
                            ${meal.moods.map(mood => {
                                const moodEmoji = {
                                    'cozy': 'üç≤',
                                    'fresh': 'ü•ó',
                                    'hearty': 'üçñ',
                                    'quick': '‚ö°',
                                    'breakfast': 'üåÖ',
                                    'seafood': 'üêü',
                                    'asian': 'ü•¢',
                                    'italian': 'üçù'
                                }[mood] || '';
                                return `<span class="badge badge-sm">${moodEmoji} ${mood}</span>`;
                            }).join('')}
                        </div>
                    </div>
                `;
                mealCard.addEventListener('click', () => selectMeal(meal));
                container.appendChild(mealCard);
            });

            document.getElementById('suggestionsArea').classList.remove('hidden');

            // Show "Show 3 more" button if there are more meals
            if (suggestionIndex + INITIAL_SHOW < currentSuggestions.length) {
                document.getElementById('showMore').classList.remove('hidden');
                const remaining = currentSuggestions.length - (suggestionIndex + INITIAL_SHOW);
                const showCount = Math.min(MORE_INCREMENT, remaining);
                document.getElementById('showMore').textContent =
                    remaining > MORE_INCREMENT ? `Show ${showCount} more ‚Üí` : `Show last ${showCount} ‚Üí`;
            } else {
                document.getElementById('showMore').classList.add('hidden');
            }
        }

        function selectMeal(meal) {
            document.getElementById('selectedMealName').textContent = meal.name;

            const ingredientsContainer = document.getElementById('ingredientsList');
            ingredientsContainer.innerHTML = '';

            if (meal.ingredients.core.length > 0) {
                const coreDiv = document.createElement('div');
                coreDiv.innerHTML = `
                    <h5 class="font-medium text-sm text-base-content/60 mb-1">Main ingredients:</h5>
                    <div class="flex flex-wrap gap-2">
                        ${meal.ingredients.core.map(ing =>
                            `<span class="badge badge-primary">${ing}</span>`
                        ).join('')}
                    </div>
                `;
                ingredientsContainer.appendChild(coreDiv);
            }

            if (meal.ingredients.pantry.length > 0) {
                const pantryDiv = document.createElement('div');
                pantryDiv.innerHTML = `
                    <h5 class="font-medium text-sm text-base-content/60 mb-1">From your pantry:</h5>
                    <div class="flex flex-wrap gap-2">
                        ${meal.ingredients.pantry.map(ing =>
                            `<span class="badge badge-outline">${ing}</span>`
                        ).join('')}
                    </div>
                `;
                ingredientsContainer.appendChild(pantryDiv);
            }

            document.getElementById('selectedMeal').classList.remove('hidden');
            document.getElementById('selectedMeal').scrollIntoView({ behavior: 'smooth' });

            // Add to recent meals
            addToRecentMeals(meal);
        }

        function loadRecentMeals() {
            const stored = localStorage.getItem(RECENT_MEALS_KEY);
            if (stored) {
                recentMeals = JSON.parse(stored);
                displayRecentMeals();
            }
        }

        function addToRecentMeals(meal) {
            // Remove if already in list
            recentMeals = recentMeals.filter(m => m.name !== meal.name);
            // Add to front
            recentMeals.unshift(meal);
            // Keep only MAX_RECENT
            recentMeals = recentMeals.slice(0, MAX_RECENT);
            // Save
            localStorage.setItem(RECENT_MEALS_KEY, JSON.stringify(recentMeals));
            displayRecentMeals();
        }

        function displayRecentMeals() {
            if (recentMeals.length === 0) {
                document.getElementById('recentMeals').classList.add('hidden');
                return;
            }

            const container = document.getElementById('recentMealsList');
            container.innerHTML = recentMeals.map(meal =>
                `<button class="btn btn-xs btn-ghost" onclick="selectMealByName('${meal.name.replace(/'/g, "\\'")}')">${meal.name}</button>`
            ).join('');

            document.getElementById('recentMeals').classList.remove('hidden');
        }

        function selectMealByName(name) {
            const meal = meals.find(m => m.name === name);
            if (meal) selectMeal(meal);
        }

        // Event handlers
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('btn-primary'));
                btn.classList.add('btn-primary');

                const mood = btn.dataset.mood;
                const moodMeals = getMealsByMood(mood);
                currentSuggestions = smartSort(moodMeals);
                suggestionIndex = 0;
                displaySuggestions();

                document.getElementById('searchInput').value = '';
            });
        });

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
                const results = searchMeals(query);
                currentSuggestions = smartSort(results);
                suggestionIndex = 0;
                displaySuggestions();

                document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('btn-primary'));
            }
        }

        document.getElementById('searchBtn').addEventListener('click', performSearch);

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        document.getElementById('showMore').addEventListener('click', () => {
            suggestionIndex += INITIAL_SHOW;
            if (suggestionIndex >= currentSuggestions.length) {
                suggestionIndex = 0;
            }
            displaySuggestions();
        });

        document.getElementById('clearSelection').addEventListener('click', () => {
            document.getElementById('selectedMeal').classList.add('hidden');
        });

        // Initialize
        loadMeals();
    </script>
</body>
</html>