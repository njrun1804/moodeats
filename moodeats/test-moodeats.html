<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodEats Test Suite</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .test-pass { color: #0f0; }
        .test-fail { color: #f00; font-weight: bold; }
        .test-section { margin: 20px 0; padding: 10px; border: 1px solid #333; }
        .summary { margin-top: 20px; padding: 15px; border: 2px solid #fff; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>MoodEats Test Suite</h1>
    <div id="results"></div>
    <div id="summary" class="summary"></div>

    <script>
        let testResults = [];
        let meals = [];

        // Test runner
        function test(name, testFn) {
            try {
                const result = testFn();
                const passed = result === true;
                testResults.push({ name, passed, error: passed ? null : result });
                return passed;
            } catch (error) {
                testResults.push({ name, passed: false, error: error.message });
                return false;
            }
        }

        // Assert helper
        function assert(condition, message) {
            if (!condition) {
                throw new Error(message || 'Assertion failed');
            }
            return true;
        }

        // Display results
        function displayResults() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');

            let html = '';
            testResults.forEach(result => {
                const className = result.passed ? 'test-pass' : 'test-fail';
                const status = result.passed ? '‚úì' : '‚úó';
                html += `<div class="${className}">${status} ${result.name}`;
                if (result.error && typeof result.error === 'string') {
                    html += ` - ${result.error}`;
                }
                html += '</div>';
            });

            resultsDiv.innerHTML = html;

            const passed = testResults.filter(r => r.passed).length;
            const failed = testResults.filter(r => !r.passed).length;
            const total = testResults.length;

            summaryDiv.innerHTML = `
                <h2>Test Summary</h2>
                <div>Total: ${total}</div>
                <div class="test-pass">Passed: ${passed}</div>
                <div class="test-fail">Failed: ${failed}</div>
                <div>Success Rate: ${Math.round((passed/total) * 100)}%</div>
                ${failed === 0 ? '<div class="test-pass"><br/>üéâ ALL TESTS PASSED!</div>' : '<div class="test-fail"><br/>‚ö†Ô∏è SOME TESTS FAILED</div>'}
            `;

            // Return exit code for CI
            return failed === 0 ? 0 : 1;
        }

        // Run tests
        async function runTests() {
            console.log('Loading meals.json...');

            // Test 1: Load meals.json
            test('meals.json loads successfully', () => {
                return fetch('meals.json')
                    .then(r => r.json())
                    .then(data => {
                        meals = data;
                        return true;
                    })
                    .catch(() => false);
            });

            await fetch('meals.json').then(r => r.json()).then(data => { meals = data; }).catch(e => console.error(e));

            // Test 2: Basic data structure
            test('meals is an array', () => {
                return assert(Array.isArray(meals), 'meals should be an array');
            });

            test('meals has at least 70 items', () => {
                return assert(meals.length >= 70, `Expected at least 70 meals, got ${meals.length}`);
            });

            // Test 3: Meal structure validation
            test('all meals have required fields', () => {
                for (let i = 0; i < meals.length; i++) {
                    const meal = meals[i];
                    assert(meal.name, `Meal ${i} missing name`);
                    assert(meal.category, `Meal ${meal.name} missing category`);
                    assert(Array.isArray(meal.moods), `Meal ${meal.name} moods not array`);
                    assert(meal.ingredients, `Meal ${meal.name} missing ingredients`);
                    assert(meal.ingredients.core, `Meal ${meal.name} missing core ingredients`);
                    assert(Array.isArray(meal.searchTerms), `Meal ${meal.name} searchTerms not array`);
                }
                return true;
            });

            // Test 4: Breakfast meals
            test('at least 10 breakfast meals exist', () => {
                const breakfastMeals = meals.filter(m => m.moods.includes('breakfast'));
                return assert(breakfastMeals.length >= 10, `Only ${breakfastMeals.length} breakfast meals found`);
            });

            test('breakfast meals have breakfast category', () => {
                const breakfastMeals = meals.filter(m => m.moods.includes('breakfast'));
                const allHaveCategory = breakfastMeals.every(m => m.category === 'breakfast');
                return assert(allHaveCategory, 'Some breakfast meals have wrong category');
            });

            // Test 5: Mood coverage
            const expectedMoods = ['cozy', 'fresh', 'hearty', 'quick', 'breakfast', 'seafood', 'asian', 'italian'];

            expectedMoods.forEach(mood => {
                test(`mood "${mood}" has meals`, () => {
                    const moodMeals = meals.filter(m => m.moods.includes(mood));
                    return assert(moodMeals.length > 0, `No meals found for mood: ${mood}`);
                });
            });

            test('hearty mood has at least 20 meals', () => {
                const heartyMeals = meals.filter(m => m.moods.includes('hearty'));
                return assert(heartyMeals.length >= 20, `Only ${heartyMeals.length} hearty meals found`);
            });

            // Test 6: Search terms
            test('toast search term exists', () => {
                const toastMeals = meals.filter(m =>
                    m.searchTerms.some(term => term.toLowerCase().includes('toast'))
                );
                return assert(toastMeals.length >= 3, `Only ${toastMeals.length} meals with 'toast' search term`);
            });

            // Test 7: No duplicate names
            test('no duplicate meal names', () => {
                const names = meals.map(m => m.name);
                const uniqueNames = new Set(names);
                return assert(names.length === uniqueNames.size, 'Duplicate meal names found');
            });

            // Test 8: Categories are valid
            const validCategories = ['breakfast', 'italian', 'japanese', 'chinese', 'texmex', 'seafood', 'soup', 'sandwich', 'side'];

            test('all meals have valid categories', () => {
                const invalidMeals = meals.filter(m => !validCategories.includes(m.category));
                if (invalidMeals.length > 0) {
                    return `Invalid categories in: ${invalidMeals.map(m => m.name).join(', ')}`;
                }
                return true;
            });

            // Test 9: Ingredients validation
            test('all meals have core ingredients', () => {
                const noCore = meals.filter(m => !m.ingredients.core || m.ingredients.core.length === 0);
                if (noCore.length > 0) {
                    return `Missing core ingredients: ${noCore.map(m => m.name).join(', ')}`;
                }
                return true;
            });

            // Test 10: Filtering logic tests
            test('breakfast filter works correctly', () => {
                const breakfastOnly = meals.filter(m => m.moods.includes('breakfast'));
                const nonBreakfast = meals.filter(m => !m.moods.includes('breakfast'));

                assert(breakfastOnly.length > 0, 'No breakfast meals found');
                assert(nonBreakfast.length > 0, 'No non-breakfast meals found');
                assert(breakfastOnly.length + nonBreakfast.length === meals.length, 'Filter math doesnt add up');

                return true;
            });

            test('quick meals exist in multiple categories', () => {
                const quickMeals = meals.filter(m => m.moods.includes('quick'));
                const categories = new Set(quickMeals.map(m => m.category));
                return assert(categories.size >= 5, `Quick meals only in ${categories.size} categories`);
            });

            // Test 11: Specific meal checks
            test('Chicken Teriyaki exists and is properly tagged', () => {
                const meal = meals.find(m => m.name === 'Chicken Teriyaki');
                assert(meal, 'Chicken Teriyaki not found');
                assert(meal.moods.includes('asian'), 'Should have asian mood');
                assert(meal.moods.includes('quick'), 'Should have quick mood');
                return true;
            });

            // Test 12: Data consistency
            test('all seafood category meals have seafood mood', () => {
                const seafoodCategory = meals.filter(m => m.category === 'seafood');
                const allHaveMood = seafoodCategory.every(m => m.moods.includes('seafood'));
                if (!allHaveMood) {
                    const missing = seafoodCategory.filter(m => !m.moods.includes('seafood'));
                    return `Missing seafood mood: ${missing.map(m => m.name).join(', ')}`;
                }
                return true;
            });

            // Display results
            displayResults();

            // For CI/CD - output JSON results
            const exitCode = testResults.every(r => r.passed) ? 0 : 1;
            console.log(JSON.stringify({
                total: testResults.length,
                passed: testResults.filter(r => r.passed).length,
                failed: testResults.filter(r => !r.passed).length,
                exitCode: exitCode,
                failures: testResults.filter(r => !r.passed)
            }, null, 2));

            // If running in Node.js environment (for CI)
            if (typeof process !== 'undefined') {
                process.exit(exitCode);
            }
        }

        // Run tests on load
        runTests();
    </script>
</body>
</html>